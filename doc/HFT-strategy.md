# 一个高频交易系统的实现 [2.1].策略模版

<div>
<p>本小结中主要介绍策略模版的设计思想和使用方法。</p>
<div>

<div>
<p>一个好的交易系统策略框架的设计，需要同时既满足与底层接口细节的充分隔离，又能完整呈现接口的重要功能。
而且还要有足够的通用型。</p>
<p>在隔离方面，举个简单的例子，目前比较常见的交易接口有`上海期货信息技术有限公司CTP接口`，`中金所技术公司Femas接口`，或者国外的`TWS`接口。这些接口的使用逻辑在很多方面是相同的，可以进行统一的抽象，同时也有很多地方具有较大的差别，需要进行特殊处理。但是整体上，我们需要在系统层面给上层的策略提供一个统一的框架，这个框架能屏蔽不同地层接口的区别。但是，如果策略需要用到某一种接口的一些特有功能，策略框架也需要提供一种访问的途径。</p>
<p>在通用型方面的例子是：如果我写一个策略，比如说是一个双腿套利的策略，我希望这个策略能够不经修改地应用到期货、股票、期权等不同的品种。而不是为每一种类型的标的单独开发一个版本。在使用的时候，仅仅需要通过配置不同的参数，就可以对不同的标的进行交易。</p>
<div>

<div>
策略模版的代码在[这里](https://github.com/solopointer/thunder-trader/blob/master/strategies/DemoStrategy_Basic/DemoStrategy_Basic.cpp)
每个策略都实现了MStrategy接口，因为在C++中没有interface这个概念，
所以[MStrategy](https://github.com/solopointer/thunder-trader/blob/master/common/StrategyDefine.h)被定义为一个纯虚类。
只有实现了MStrategy的每一个接口才能被称之为一个正确的策略。这些接口函数大致可以分为两类：
> * 以**On**开头的函数都是回调函数(Callback), 例如OnTick等，都是被交易系统调用来实现一些事件通知。
> * 以**Get**开头的函数是用来获取策略信息的函数，系统需要通过这些函数获取策略的参数信息、绘图信息等等。

但是这除非需要实现一些特殊的策略，否则这些我们只需要直接实现`OnInquiry`，`OnInit`，`OnTick`，`OnTrade`，`OnOrder`，`OnEndup`，`OnInit_FromArchive`这7个回调函数。剩余的函数可以通过一些与定义的宏来间接实现。

* `OnInquiry`: 主要负责响应一些来自客户端的查询，例如客户端请求查询策略的持仓情况等，默认返回true。
* `OnInit`: 在这里实现一些策略初始化的工作，这个回调函数只会在策略被部署的时候调用一次。
* `OnTick`: 行情数据通过该函数传递给策略。
* `OnTrade`: 如果报单有成交会通过该函数通知策略，无论是部分成交函数全部成交。
* `OnOrder`: 如果报单状态发生了变化，会在这里通知。例如报单由‘已提交撤销申请’变为‘已经撤销成功’等等。
* `OnEndup`: 如果客户端将策略撤销，交易系统会被撤销前调用该函数。
* `OnInit_FromArchive`:
</div>

